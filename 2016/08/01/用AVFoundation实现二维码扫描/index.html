<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）AVFoundation是一个可以用来使用和创建基于时间的视听媒体的框架，例如：您可以用它来检查，创建，编辑或是重新编码媒体文件。也可以从设备中获取输入流，在视频实时播放时操作和回放。下图时AVFoundation在IOS中的架构。
具体请看http://www.jianshu.com/p/cc79c45b4cc">
<meta property="og:type" content="article">
<meta property="og:title" content="用AVFoundation实现二维码扫描">
<meta property="og:url" content="http://menhui222.github.io/2016/08/01/用AVFoundation实现二维码扫描/index.html">
<meta property="og:site_name" content="menhui222'blog">
<meta property="og:description" content="首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）AVFoundation是一个可以用来使用和创建基于时间的视听媒体的框架，例如：您可以用它来检查，创建，编辑或是重新编码媒体文件。也可以从设备中获取输入流，在视频实时播放时操作和回放。下图时AVFoundation在IOS中的架构。
具体请看http://www.jianshu.com/p/cc79c45b4cc">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Art/frameworksBlockDiagram_2x.png">
<meta property="og:image" content="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Art/frameworksBlockDiagramOSX_2x.png">
<meta property="og:updated_time" content="2016-08-18T06:53:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用AVFoundation实现二维码扫描">
<meta name="twitter:description" content="首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）AVFoundation是一个可以用来使用和创建基于时间的视听媒体的框架，例如：您可以用它来检查，创建，编辑或是重新编码媒体文件。也可以从设备中获取输入流，在视频实时播放时操作和回放。下图时AVFoundation在IOS中的架构。
具体请看http://www.jianshu.com/p/cc79c45b4cc">
<meta name="twitter:image" content="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Art/frameworksBlockDiagram_2x.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://menhui222.github.io/2016/08/01/用AVFoundation实现二维码扫描/"/>

  <title> 用AVFoundation实现二维码扫描 | menhui222'blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">menhui222'blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                用AVFoundation实现二维码扫描
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-01T16:28:29+08:00" content="2016-08-01">
              2016-08-01
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）"><a href="#首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）" class="headerlink" title="首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）"></a>首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）</h4><p>AVFoundation是一个可以用来使用和创建基于时间的视听媒体的框架，例如：您可以用它来检查，创建，编辑或是重新编码媒体文件。也可以从设备中获取输入流，在视频实时播放时操作和回放。下图时AVFoundation在IOS中的架构。</p>
<p><img src="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Art/frameworksBlockDiagram_2x.png" alt=""><br><img src="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Art/frameworksBlockDiagramOSX_2x.png" alt=""><br>具体请看<a href="http://www.jianshu.com/p/cc79c45b4ccf" target="_blank" rel="external">http://www.jianshu.com/p/cc79c45b4ccf</a></p>
<p>为了熟悉AVFoundation 我自己写了二维码扫描<br>为了捕捉视频,我们需要这样几种类（与其它的子类）。</p>
<ul>
<li><p>AVCaptureDevice 代表了输入设备,例如摄像头与麦克风。</p>
</li>
<li><p>AVCaptureInput 代表了输入数据源</p>
</li>
<li><p>AVCaptureOutput 代表了输出数据源</p>
</li>
<li><p>AVCaptureSession 用于协调输入与输出之间的数据流</p>
</li>
</ul>
<p>并且还有AVCaptureVideoPreviewLayer提供摄像头的预览功能</p>
<p>1.创建AVCaputureSession。这个是对输出流合输入流的处理</p>
<p>2.创建AVCaptureDevice。  这个是获取输入的设备</p>
<pre><code> /*!
 @method defaultDeviceWithMediaType:
 @abstract
    Returns an AVCaptureDevice instance for the default device of the given media type.

 @param mediaType
    The media type, such as AVMediaTypeVideo, AVMediaTypeAudio, or AVMediaTypeMuxed, supported by the returned device.
 @result
    The default device with the given media type, or nil if no device with that media type exists.

 @discussion
    This method returns the default device of the given media type currently available on the system. For example, for
    AVMediaTypeVideo, this method will return the built in camera that is primarily used for capture and recording.
    Media type constants are defined in AVMediaFormat.h.
*/
public class func defaultDeviceWithMediaType(mediaType: String!) -&gt; AVCaptureDevice!
</code></pre><p>3.创建AVCaptureDeviceInput,添加到session</p>
<pre><code>do {
     //输入流
     let  input = try AVCaptureDeviceInput(device: device)
     session.addInput(input)
 }catch{
     print(&quot;相机不可以&quot;)
 }
</code></pre><p>4.创建AVCaptureOutput，并设置代理，添加到session</p>
<pre><code>let output = AVCaptureMetadataOutput()
output.metadataObjectTypes = [AVMetadataObjectTypeQRCode]
output.setMetadataObjectsDelegate(self, queue:dispatch_get_main_queue() )
session.canSetSessionPreset(AVCaptureSessionPresetHigh)
session.addOutput(output)
</code></pre><p>代码：</p>
<pre><code>//流的处理 （输出，输入）
                let session = AVCaptureSession()
                //获取设备//摄像头和麦克风

                let device = AVCaptureDevice.defaultDeviceWithMediaType(AVMediaTypeVideo)
                do {
                    //输入流
                    let  input = try AVCaptureDeviceInput(device: device)
                    session.addInput(input)
                }catch{
                     let alertvc = UIAlertController(title: &quot;温馨提示&quot;, message: &quot;请在iPhone的\&quot;设置-隐私-相机\&quot;选项中,允许本程序访问您的相机&quot;, preferredStyle:UIAlertControllerStyle.Alert)
                    let certain = UIAlertAction(title: &quot;确定&quot;, style: UIAlertActionStyle.Default, handler: { (_) in
                        guard let url = NSURL(string:UIApplicationOpenSettingsURLString) else {return}

                        if UIApplication.sharedApplication().canOpenURL(url) {
                            UIApplication.sharedApplication().openURL(url)
                        }



                    })
                    let cancel = UIAlertAction(title: &quot;取消&quot;, style: UIAlertActionStyle.Cancel, handler: { (_) in

                    })
                    alertvc.addAction(cancel)
                    alertvc.addAction(certain)
                    return

                }
                //在生成拍摄回话时原来直接设置的是最高清画质，但对于ipod 5这类低配设备是不支持的，故在此我采取了下面这种方式来设置画质。


                //session.sessionPreset = AVCaptureSessionPreset1920x1080;//设置图像输出质量


                // 输出流 代理回调
                let output = AVCaptureMetadataOutput()



                session.canSetSessionPreset(AVCaptureSessionPresetHigh)
                session.addOutput(output)
                output.metadataObjectTypes = [AVMetadataObjectTypeQRCode]
                output.setMetadataObjectsDelegate(self, queue:dispatch_get_main_queue() )
                let previewLayer = AVCaptureVideoPreviewLayer(session:session)
                previewLayer.videoGravity = AVLayerVideoGravityResizeAspectFill

                previewLayer.frame = CGRectMake(0, 0, kScreen_width, kScreen_height)

                let rect = CGRectMake((kScreen_width - 250) / 2.0, (kScreen_height - 250 - 72)/2.0, 250.0, 250.0);
                print(rect)
                //let rectOfInterest = previewLayer.metadataOutputRectOfInterestForRect(rect)
                let rectOfInterest = CGRectMake(rect.origin.y/kScreen_height, rect.origin.x/kScreen_width,  rect.size.height/kScreen_height,rect.size.width/kScreen_width)
                print(rectOfInterest)
                output.rectOfInterest = rectOfInterest
                self.view.layer.addSublayer(previewLayer)
                //执行
                session.startRunning()
  var maskY:CGFloat = 0.0
    if (self.navigationController != nil){
        maskY = 64.0
    }

    let maskView = UIView(frame:CGRectMake(0, maskY, kScreen_width, kScreen_height - maskY))
    maskView.backgroundColor = UIColor(red: 0, green: 0, blue: 0, alpha: 0.6)
    self.view.addSubview(maskView)

    let rectPath = UIBezierPath(rect:CGRectMake(0, 0, kScreen_width, kScreen_height))
    //    [rectPath appendPath:[[UIBezierPath bezierPathWithRect:CM((SCREEN_WIDTH - 250) / 2, 66, 250, 250)] bezierPathByReversingPath]];
    let roundedRect = UIBezierPath(roundedRect:CGRectMake((kScreen_width - 250) / 2, (kScreen_height - 250 - 72)/2 - maskY, 250, 250),cornerRadius:1.0)
    rectPath.appendPath(roundedRect.bezierPathByReversingPath())

    let shapeLayer = CAShapeLayer()
    shapeLayer.path = rectPath.CGPath;

    maskView.layer.mask = shapeLayer;

    let scanAreaImageView = UIImageView(frame:rect)

    scanAreaImageView.layer.cornerRadius = 2
    scanAreaImageView.layer.borderColor = UIColor.orangeColor().CGColor
    scanAreaImageView.layer.borderWidth = 1
    self.view.addSubview(scanAreaImageView)








   extension QRCatchViewControll:AVCaptureMetadataOutputObjectsDelegate{

func captureOutput(captureOutput: AVCaptureOutput!, didOutputMetadataObjects metadataObjects: [AnyObject]!, fromConnection connection: AVCaptureConnection!){

    if metadataObjects.count &lt;= 0{
        print(&quot;metadataObjects.count\(metadataObjects.count)&quot;)
        return
    }

    for  metadataObject  in metadataObjects {
        guard let qrcodeTypeObject = metadataObject as? AVMetadataMachineReadableCodeObject else{return}
        if qrcodeTypeObject.type == AVMetadataObjectTypeQRCode {
            print(qrcodeTypeObject.stringValue)
        }else{
            print(qrcodeTypeObject.stringValue)

        }

    }


}
</code></pre>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/27/用CAShapeLayer-实现打钩动画轨迹效果/" rel="next" title="用CAShapeLayer 实现打钩动画轨迹效果">
                <i class="fa fa-chevron-left"></i> 用CAShapeLayer 实现打钩动画轨迹效果
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars3.githubusercontent.com/u/12657294?v=3&s=460"
               alt="menhui222" />
          <p class="site-author-name" itemprop="name">menhui222</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）"><span class="nav-number">1.</span> <span class="nav-text">首先对AVFoundation的了解（指我的了解因为我能力有限所以可能有不到位的地方）</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">menhui222</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
